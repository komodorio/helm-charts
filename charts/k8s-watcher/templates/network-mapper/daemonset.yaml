{{- define "network_mapper.daemonset.container" }}
{{- if (.Values.watcher.networkMapper).enable | default true }}
- name: {{ template "network.sniffer.fullName" . }}
  image: '{{ ((.Values.network_mapper).sniffer).repository | default "public.ecr.aws/komodor-public" }}/{{ ((.Values.network_mapper).sniffer).image | default "network-mapper-sniffer" }}:{{ ((.Values.network_mapper).sniffer).tag | default "v0.1.27" }}'
  imagePullPolicy: {{ ((.Values.network_mapper).sniffer).pullPolicy | default "IfNotPresent" }}
  resources:
    {{- toYaml ((.Values.network_mapper).sniffer).resources | nindent 10 }}
  env:
    - name: OTTERIZE_MAPPER_API_URL
      value: http://{{ template "network.mapper.fullName" . }}:9090/query
    - name: OTTERIZE_DEBUG
      value: {{ (.Values.network_mapper).debug | default "false" | quote }}
  volumeMounts:
    - mountPath: /hostproc
      name: proc
      readOnly: true
{{- end }}
{{- end }}

{{- define "network_mapper.daemonset.network" }}
{{- if(.Values.watcher.networkMapper).enable | default true }}
hostNetwork: true
dnsPolicy: ClusterFirstWithHostNet
{{- end }}
{{- end }}

{{- define "network_mapper.daemonset.volumes" }}
{{- if (.Values.watcher.networkMapper).enable | default true }}
- hostPath:
    path: /proc
    type: ""
  name: proc
{{- end }}
{{- end }}