{{- if .Values.crd.create }}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  labels:
    {{ include "podmotion.labels" . | nindent 4 }}
  name: migrations.runtime.podmotion.komodor.com
spec:
  group: runtime.podmotion.komodor.com
  names:
    kind: Migration
    listKind: MigrationList
    plural: migrations
    singular: migration
  scope: Namespaced
  versions:
    - additionalPrinterColumns:
        - description: Current phase of the migration (Pending, Running, Completed, Failed,
            Unclaimed)
          jsonPath: .status.containers[*].condition.phase
          name: Phase
          type: string
        - description: Type of workload being migrated (Deployment, StatefulSet, DaemonSet,
            Job, Pod)
          jsonPath: .spec.workloadKind
          name: Workload
          type: string
        - description: Node where the pod is migrating from
          jsonPath: .spec.sourceNode
          name: Source Node
          type: string
        - description: Node where the pod is migrating to
          jsonPath: .spec.targetNode
          name: Target Node
          type: string
        - description: Whether this is a live (lazy) migration
          jsonPath: .spec.liveMigration
          name: Live
          priority: 1
          type: boolean
        - description: Time taken to checkpoint the original container
          jsonPath: .status.containers[*].checkpointDuration
          name: Checkpoint Duration
          priority: 1
          type: string
        - description: Approximation of time from original container shut down to restore
            completion on new container
          jsonPath: .status.containers[*].migrationDuration
          name: Migration Duration
          type: string
        - description: Time since the migration was created
          jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
        - description: Reason for migration failure if Phase is Failed
          jsonPath: .status.containers[*].condition.reason
          name: Failure Reason
          priority: 1
          type: string
      name: v1
      schema:
        openAPIV3Schema:
          description: Migration tracks container live migrations done by podmotion.
          properties:
            apiVersion:
              description: |-
                APIVersion defines the versioned schema of this representation of an object.
                Servers should convert recognized schemas to the latest internal value, and
                may reject unrecognized values.
                More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
              type: string
            kind:
              description: |-
                Kind is a string value representing the REST resource this object represents.
                Servers may infer this from the endpoint the client submits requests to.
                Cannot be updated.
                In CamelCase.
                More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
              type: string
            metadata:
              type: object
            spec:
              properties:
                containers:
                  description: Containers to be migrated
                  items:
                    properties:
                      id:
                        type: string
                      imageServer:
                        description: ImageServer to pull the CRIU checkpoint image from.
                        properties:
                          host:
                            type: string
                          port:
                            type: integer
                        required:
                          - host
                          - port
                        type: object
                      name:
                        type: string
                      pageServer:
                        description: PageServer to pull the memory pages from during
                          lazy migration.
                        properties:
                          host:
                            type: string
                          port:
                            type: integer
                        required:
                          - host
                          - port
                        type: object
                      ports:
                        items:
                          format: int32
                          type: integer
                        type: array
                    required:
                      - id
                      - name
                    type: object
                  type: array
                  x-kubernetes-list-map-keys:
                    - name
                  x-kubernetes-list-type: map
                controllerRevisionHash:
                  description: |-
                    ControllerRevisionHash of the source pod. This is used to find a suitable target
                    pod for StatefulSet and DaemonSet-managed pods.
                  type: string
                jobName:
                  description: |-
                    JobName of the source pod. This is used to find a suitable target
                    pod for Job and CronJob-managed pods.
                  type: string
                liveMigration:
                  description: |-
                    LiveMigration indicates if this migration is done live (lazy) or not. If
                    set, the source node will setup a page server to serve memory pages
                    during live migration. If false, the image copy will include all memory
                    pages, which might result in a slower migration.
                  type: boolean
                podTemplateHash:
                  description: |-
                    PodTemplateHash of the source pod. This is used to find a suitable target
                    pod for Deployment-managed pods.
                  type: string
                restoreReady:
                  description: |-
                    RestoreReady indicates the shim is up and running and is ready to restore
                    so checkpointing can be started on the other side.
                  type: boolean
                sourceNode:
                  description: SourceNode of the pod to be migrated
                  type: string
                sourcePod:
                  description: SourcePod of the migration
                  type: string
                targetNode:
                  description: TargetNode of the pod to be migrated
                  type: string
                targetPod:
                  description: TargetPod of the migration
                  type: string
                workloadKind:
                  description: WorkloadKind indicates the type of workload (Deployment,
                    StatefulSet, DaemonSet, Job, CronJob, or Pod)
                  type: string
              required:
                - containers
                - restoreReady
                - sourceNode
              type: object
            status:
              properties:
                containers:
                  description: Containers indicates the status of the individual container
                    migrations.
                  items:
                    properties:
                      checkpointDuration:
                        type: string
                      condition:
                        properties:
                          phase:
                            type: string
                          reason:
                            type: string
                        type: object
                      migrationDuration:
                        type: string
                      name:
                        type: string
                      pausedAt:
                        format: date-time
                        type: string
                      restoredAt:
                        format: date-time
                        type: string
                    required:
                      - condition
                      - name
                    type: object
                  type: array
                  x-kubernetes-list-map-keys:
                    - name
                  x-kubernetes-list-type: map
              required:
                - containers
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}

{{- end }}
